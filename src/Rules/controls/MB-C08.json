{
  "control": "MB-C08",
  "title": "Cron Job Reliability",
  "rules": [
    {
      "id": "MB-R046",
      "title": "Crontab entries present (Magento cron)",
      "control": "MB-C08",
      "severity": "medium",
      "op": "any",
      "checks": [
        {
          "name": "crontab_grep",
          "args": {
            "users": [
              "www-data",
              "nginx",
              "apache",
              "http",
              "www",
              "magento",
              "deploy"
            ],
            "patterns": [
              "(?:^|\\s)(?:php\\s+[^\\n]*?)?bin\\/magento\\s+cron:run\\b",
              "(?:^|\\s)(?:php\\s+[^\\n]*?)?bin\\/magento\\s+setup:cron:run\\b",
              "(?:^|\\s)(?:php\\s+[^\\n]*?)?update\\/cron\\.php\\b"
            ],
            "timeout_ms": 2500
          }
        },
        {
          "name": "code_grep",
          "optional": true,
          "args": {
            "paths": [
              ".",
              "deploy",
              "docs",
              ".github",
              ".gitlab-ci",
              ".circleci"
            ],
            "include_ext": [
              "sh",
              "bash",
              "txt",
              "md",
              "conf",
              "yml",
              "yaml",
              "ini",
              "env",
              "dockerfile"
            ],
            "must_match": [
              "(?:^|\\s)(?:php\\s+[^\\n]*?)?bin\\/magento\\s+cron:run\\b"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Found Magento cron run command in repository or deployment docs.",
        "fail": "No Magento cron entry found in repo or docs. Ensure 'bin/magento cron:run' runs every minute via crontab or scheduler."
      }
    },
    {
      "id": "MB-R047",
      "title": "Cron heartbeat is recent (<= 900s)",
      "control": "MB-C08",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "fs_mtime_max_age",
          "args": {
            "file": "var/cron/cron.timestamp",
            "seconds": 900
          }
        }
      ],
      "messages": {
        "pass": "Cron heartbeat is recent (<= 15 minutes).",
        "fail": "Cron has not run in the last 15 minutes. Investigate cron service and schedule."
      }
    },
    {
      "id": "MB-R048",
      "title": "Cron backlog below threshold",
      "control": "MB-C08",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "text_grep",
          "args": {
            "file": "var/cron/queue.size",
            "must_not_match": [
              "^([1-9][0-9]{3,})$"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Cron queue size is within acceptable limits.",
        "fail": "Cron queue size is high. Jobs are backloggedâ€”scale workers or fix failing jobs."
      }
    }
  ]
}