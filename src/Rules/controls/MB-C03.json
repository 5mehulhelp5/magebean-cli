{
  "control": "MB-C03",
  "title": "Secure Coding Practices",
  "rules": [
    {
      "id": "MB-R012",
      "title": "No raw SQL without abstraction",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php",
              "phtml"
            ],
            "must_not_match": [
              "->query\\(",
              "mysqli_query\\(",
              "new\\s+PDO\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe raw SQL statements detected; database queries use abstraction layers.",
        "fail": "Unsafe raw SQL calls detected (query, mysqli_query, or new PDO). Use Magento DB abstraction or safe ORM."
      }
    },
    {
      "id": "MB-R013",
      "title": "Template output is escaped",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml"
            ],
            "must_match": [
              "escapeHtml\\(",
              "escapeHtmlAttr\\(",
              "\\$block->escapeHtml"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Template output uses proper escaping functions.",
        "fail": "Unescaped template output detected. Use escapeHtml() or escapeHtmlAttr() for safe rendering."
      }
    },
    {
      "id": "MB-R014",
      "title": "Avoid PHP superglobals directly",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "\\$_GET\\[",
              "\\$_POST\\[",
              "\\$_REQUEST\\["
            ]
          }
        }
      ],
      "messages": {
        "pass": "No direct access to PHP superglobals detected.",
        "fail": "Direct use of $_GET/$_POST/$_REQUEST found. Use Magento request objects for sanitization."
      }
    },
    {
      "id": "MB-R015",
      "title": "Forms include CSRF tokens (form_key)",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php",
              "phtml"
            ],
            "must_match": [
              "form_key",
              "getFormKey\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "Forms include CSRF protection via form_key.",
        "fail": "Forms without form_key detected. Add CSRF token for protection."
      }
    },
    {
      "id": "MB-R016",
      "title": "SSRF protections present",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "allowlist|whitelist",
              "CURLOPT_CONNECTTIMEOUT|CURLOPT_TIMEOUT"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Outbound HTTP requests include SSRF protections (allowlists and timeouts).",
        "fail": "No SSRF protections found. Add domain allowlists and connection timeouts."
      }
    },
    {
      "id": "MB-R017",
      "title": "No unsafe deserialization",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?<!->)(?<!::)(?<!function[ \\t])\\b\\\\?unserialize\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe unserialize() usage detected; safe serialization methods in use.",
        "fail": "Unsafe unserialize() calls detected. Replace with JSON or Magento Serializer classes."
      }
    },
    {
      "id": "MB-R018",
      "title": "Command execution functions are not used",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?<!->)(?<!::)\\b\\\\?(?:exec|shell_exec|system)\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe command execution functions detected.",
        "fail": "exec(), shell_exec(), or system() calls found. Avoid OS command execution."
      }
    },
    {
      "id": "MB-R019",
      "title": "No eval/assert/dynamic execution",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "eval\\(",
              "assert\\(",
              "create_function\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No dangerous dynamic execution functions detected.",
        "fail": "Use of eval/assert/create_function detected. Remove or refactor these functions."
      }
    },
    {
      "id": "MB-R020",
      "title": "Path traversal protections (sanitization present)",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "(?:realpath|\\$this->fileDriver->getRealPath|resolvePath|DirectoryList)\\(",
              "(?:basename|pathinfo\\s*\\([^,]+,\\s*PATHINFO_BASENAME)"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Path sanitization functions (realpath/basename) are present.",
        "fail": "No path sanitization functions found. Add realpath() or basename() to prevent traversal."
      }
    },
    {
      "id": "MB-R021",
      "title": "Secure file upload handling",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "isAllowedExtension|pathinfo\\s*\\([^,]+,\\s*PATHINFO_EXTENSION\\)|getClientOriginalExtension",
              "validateMime|mime_content_type|getClientMimeType|finfo_(?:open|file)|getMimeType",
              "max_file_size|filesize\\(|getSize\\s*\\(|\\$_FILES\\[[^\\]]+\\]\\s*\\[\\s*['\\\"]size['\\\"]\\s*\\]"
            ]
          }
        }
      ],
      "messages": {
        "pass": "File uploads are validated with extension, MIME type, and size checks.",
        "fail": "File upload handling lacks validation. Add allowed extensions, MIME type checks, and size limits."
      }
    },
    {
      "id": "MB-R022",
      "title": "Escaping for JS context",
      "control": "MB-C03",
      "severity": "low",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml",
              "js",
              "html"
            ],
            "must_match": [
              "escapeJs\\(",
              "json_encode\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "JavaScript context output uses proper escaping.",
        "fail": "No escaping for JavaScript context detected. Use escapeJs() or json_encode()."
      }
    },
    {
      "id": "MB-R023",
      "title": "Use CSPRNG; avoid weak PRNG",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?i)(token|otp|one.?time.?password|pass(word)?|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|code)[^\\n;\\)]{0,120}\\b(?:rand|mt_rand|array_rand|shuffle|str_shuffle|uniqid)\\s*\\(",
              "(?i)\\b(?:rand|mt_rand|array_rand|shuffle|str_shuffle|uniqid)\\s*\\([^\\n;\\)]{0,120}(token|otp|one.?time.?password|pass(word)?|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|code)"
            ]
          }
        },
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "(?i)(token|otp|one.?time.?password|pass(word)?|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|code)[^\\n;\\)]{0,120}\\b(?:random_int|random_bytes|openssl_random_pseudo_bytes)\\s*\\(",
              "(?i)\\b(?:random_int|random_bytes|openssl_random_pseudo_bytes)\\s*\\([^\\n;\\)]{0,120}(token|otp|one.?time.?password|pass(word)?|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|code)"
            ]
          }
        }
      ],
      "messages": {
        "pass": "No insecure RNG in security-sensitive contexts, or secure RNG (random_int/random_bytes) is used when generating secrets.",
        "fail": "Insecure RNG (rand/mt_rand/array_rand/uniqid/shuffle) used near security-sensitive code (token/password/nonce...). Use random_int/random_bytes."
      }
    },
    {
      "id": "MB-R024",
      "title": "Sensitive data not logged",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "logger->(info|debug|notice)\\([^)]*password",
              "logger->(info|debug|notice)\\([^)]*Authorization",
              "logger->(info|debug|notice)\\([^)]*(card_number|cvv)"
            ]
          }
        }
      ],
      "messages": {
        "pass": "No sensitive data (passwords, tokens, card details) logged in code.",
        "fail": "Sensitive data logging detected. Remove logs containing passwords, tokens, or card information."
      }
    },
    {
      "id": "MB-R025",
      "title": "Use Magento APIs for crypto & session",
      "control": "MB-C03",
      "severity": "medium",
      "op": "any",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "Magento\\\\\\\\Framework\\\\\\\\Encryption|Magento\\\\\\\\Framework\\\\\\\\Encryption\\\\\\\\EncryptorInterface",
              "Magento\\\\\\\\Framework\\\\\\\\Session"
            ]
          }
        },
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "session_start\\(",
              "\\$_SESSION\\[",
              "openssl_(?:encrypt|decrypt)\\(",
              "mcrypt_"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Magento's built-in APIs are used for encryption and session management.",
        "fail": "Custom crypto/session code found. Use Magento Framework Encryption and Session APIs instead."
      }
    }
  ]
}