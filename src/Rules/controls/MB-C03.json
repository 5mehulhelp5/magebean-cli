{
  "control": "MB-C03",
  "title": "Secure Coding Practices",
  "rules": [
    {
      "id": "MB-R012",
      "title": "No raw SQL without abstraction",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php",
              "phtml"
            ],
            "must_not_match": [
              "->query\\(",
              "mysqli_query\\(",
              "new\\s+PDO\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe raw SQL statements detected; database queries use abstraction layers.",
        "fail": "Unsafe raw SQL calls detected (query, mysqli_query, or new PDO). Use Magento DB abstraction or safe ORM."
      }
    },
    {
      "id": "MB-R013",
      "title": "Template output is escaped",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml"
            ],
            "must_not_match": [
              "(?s)<\\?=\\s*(?![^\\n\\r]*?(?:escapeHtml|escapeHtmlAttr|escapeUrl|escapeJs|escapeCss)\\s*\\().*?\\?>"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Template output uses proper escaping functions.",
        "fail": "Unescaped template output detected. Use escapeHtml() or escapeHtmlAttr() for safe rendering."
      }
    },
    {
      "id": "MB-R014",
      "title": "Avoid PHP superglobals directly",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "\\$_GET\\[",
              "\\$_POST\\[",
              "\\$_REQUEST\\["
            ]
          }
        }
      ],
      "messages": {
        "pass": "No direct access to PHP superglobals detected.",
        "fail": "Direct use of $_GET/$_POST/$_REQUEST found. Use Magento request objects for sanitization."
      }
    },
    {
      "id": "MB-R015",
      "title": "Forms include CSRF tokens (form_key)",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "phtml",
              "php",
              "html"
            ],
            "must_not_match": [
              "(?is)<form[^>]*method\\s*=\\s*['\\\"]?post['\\\"]?[^>]*>(?![\\s\\S]*?(?:form_key|getFormKey\\s*\\(|<form_key\\b|data-mage-init[^>]*formKey))[\\s\\S]*?<\\/form>"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Forms include CSRF protection via form_key.",
        "fail": "Forms without form_key detected. Add CSRF token for protection."
      }
    },
    {
      "id": "MB-R016",
      "title": "SSRF protections present",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?i)\\bcurl_init\\s*\\(\\s*\\$?_?(GET|POST|REQUEST)\\b",
              "(?i)\\bcurl_setopt\\s*\\([^;\\n]*CURLOPT_URL[^;\\n]*\\$?_?(GET|POST|REQUEST)\\b",
              "(?i)\\b(file_get_contents|fopen)\\s*\\(\\s*\\$?_?(GET|POST|REQUEST)\\b",
              "(?i)\\b(fsockopen|stream_socket_client)\\s*\\(\\s*\\$?_?(GET|POST|REQUEST)\\b"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Outbound HTTP requests include SSRF protections (allowlists and timeouts).",
        "fail": "No SSRF protections found. Add domain allowlists and connection timeouts."
      }
    },
    {
      "id": "MB-R017",
      "title": "No unsafe deserialization",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?<!->)(?<!::)(?<!function[ \\t])\\b\\\\?unserialize\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe unserialize() usage detected; safe serialization methods in use.",
        "fail": "Unsafe unserialize() calls detected. Replace with JSON or Magento Serializer classes."
      }
    },
    {
      "id": "MB-R018",
      "title": "Command execution functions are not used",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?<!->)(?<!::)\\b\\\\?(?:exec|shell_exec|system)\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe command execution functions detected.",
        "fail": "exec(), shell_exec(), or system() calls found. Avoid OS command execution."
      }
    },
    {
      "id": "MB-R019",
      "title": "No eval/assert/dynamic execution",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "eval\\(",
              "assert\\(",
              "create_function\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No dangerous dynamic execution functions detected.",
        "fail": "Use of eval/assert/create_function detected. Remove or refactor these functions."
      }
    },
    {
      "id": "MB-R020",
      "title": "Path traversal protections (sanitization present)",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?i)(?:file_get_contents|fopen|unlink|copy|rename|include|require|require_once)\\s*\\(\\s*\\$?_?(?:GET|POST|REQUEST|FILES)\\b(?![^;]*?(basename|realpath|resolvePath|DirectoryList))"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Path sanitization functions (realpath/basename) are present.",
        "fail": "No path sanitization functions found. Add realpath() or basename() to prevent traversal."
      }
    },
    {
      "id": "MB-R021",
      "title": "Secure file upload handling",
      "control": "MB-C03",
      "severity": "medium",
      "op": "any",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?is)move_uploaded_file\\s*\\([^;\\n]*\\$_FILES[^;\\n]*\\)(?![^;\\n]{0,300}(?:finfo_(?:open|file)|mime_content_type|get(?:MimeType|ClientMimeType)|validateMime|pathinfo\\s*\\([^,]+,\\s*PATHINFO_BASENAME|PATHINFO_EXTENSION|setAllowedExtensions|checkMimeType|isValid|validateFile))"
            ]
          }
        },
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?is)\\$_FILES\\s*\\[[^\\]]+\\]\\s*\\[\\s*['\\\"]tmp_name['\\\"]\\s*\\][^;\\n]{0,200}\\b(?:copy|rename|file_put_contents|fopen)\\s*\\([^;\\n]*\\)(?![^;\\n]{0,300}(?:finfo_(?:open|file)|mime_content_type|get(?:MimeType|ClientMimeType)|validateMime|pathinfo\\s*\\([^,]+,\\s*PATHINFO_BASENAME|PATHINFO_EXTENSION|setAllowedExtensions|checkMimeType|isValid|validateFile))"
            ]
          }
        },
        {
          "name": "code_grep",
          "optional": true,
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "(?i)finfo_(?:open|file)|mime_content_type|get(?:MimeType|ClientMimeType)|validateMime|pathinfo\\s*\\([^,]+,\\s*PATHINFO_(?:BASENAME|EXTENSION)|setAllowedExtensions|checkMimeType|isValid|validateFile|\\\\Magento\\\\Framework\\\\File\\\\Uploader|\\\\Magento\\\\MediaStorage\\\\Model\\\\File\\\\Uploader"
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unsafe file upload flows detected (user file is validated or uploads not used).",
        "fail": "Potential unsafe upload: user file moved/stored without nearby MIME/extension validation."
      }
    },
    {
      "id": "MB-R022",
      "title": "Escaping for JS context",
      "control": "MB-C03",
      "severity": "low",
      "op": "any",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml",
              "html"
            ],
            "must_not_match": [
              "(?is)<script[^>]*>[\\s\\S]*?<\\?=\\s*(?![^?]*?(?:escapeJs|json_encode)\\s*\\()[\\s\\S]*?\\?>[\\s\\S]*?<\\/script>"
            ]
          }
        },
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml",
              "html"
            ],
            "must_not_match": [
              "(?is)on[a-z]+\\s*=\\s*['\\\"][^'\\\"]*<\\?=\\s*(?![^?]*?(?:escapeJs|json_encode)\\s*\\()[\\s\\S]*?\\?>[^'\\\"]*['\\\"]"
            ]
          }
        },
        {
          "name": "code_grep",
          "optional": true,
          "args": {
            "paths": [
              "app/design"
            ],
            "include_ext": [
              "phtml",
              "html",
              "js"
            ],
            "must_match": [
              "(?:(?:->|::)\\s*)?escapeJs\\s*\\(",
              "json_encode\\s*\\("
            ]
          }
        }
      ],
      "messages": {
        "pass": "No unescaped dynamic PHP output detected in JavaScript context.",
        "fail": "Unescaped PHP output found in JavaScript context. Use escapeJs() or json_encode()."
      }
    },
    {
      "id": "MB-R023",
      "title": "Use CSPRNG; avoid weak PRNG",
      "control": "MB-C03",
      "severity": "high",
      "op": "any",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "(?i)\\b(token|otp|one.?time.?password|password|passcode|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|verification.?code|auth.?code)\\b[^\\n;\\)]{0,120}\\b(?:rand|mt_rand|array_rand|shuffle|str_shuffle|uniqid)\\s*\\(",
              "(?i)\\b(?:rand|mt_rand|array_rand|shuffle|str_shuffle|uniqid)\\s*\\([^\\n;\\)]{0,120}\\b(token|otp|one.?time.?password|password|passcode|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|verification.?code|auth.?code)\\b"
            ]
          }
        },
        {
          "name": "code_grep",
          "optional": true,
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_match": [
              "(?i)\\b(token|otp|one.?time.?password|password|passcode|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|verification.?code|auth.?code)\\b[^\\n;\\)]{0,120}\\b(?:random_int|random_bytes|openssl_random_pseudo_bytes)\\s*\\(",
              "(?i)\\b(?:random_int|random_bytes|openssl_random_pseudo_bytes)\\s*\\([^\\n;\\)]{0,120}\\b(token|otp|one.?time.?password|password|passcode|reset|nonce|secret|api[_-]?key|key|salt|verify|activation|verification.?code|auth.?code)\\b"
            ]
          }
        }
      ],
      "messages": {
        "pass": "No weak PRNG detected near security-sensitive code (or no such code present).",
        "fail": "Weak PRNG (rand/mt_rand/array_rand/uniqid/shuffle) used near security-sensitive code. Use random_int/random_bytes."
      }
    },
    {
      "id": "MB-R024",
      "title": "Sensitive data not logged",
      "control": "MB-C03",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "logger->(info|debug|notice)\\([^)]*password",
              "logger->(info|debug|notice)\\([^)]*Authorization",
              "logger->(info|debug|notice)\\([^)]*(card_number|cvv)"
            ]
          }
        }
      ],
      "messages": {
        "pass": "No sensitive data (passwords, tokens, card details) logged in code.",
        "fail": "Sensitive data logging detected. Remove logs containing passwords, tokens, or card information."
      }
    },
    {
      "id": "MB-R025",
      "title": "Use Magento APIs for crypto & session",
      "control": "MB-C03",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "code_grep",
          "args": {
            "paths": [
              "app"
            ],
            "include_ext": [
              "php"
            ],
            "must_not_match": [
              "session_start\\(",
              "\\$_SESSION\\[",
              "openssl_(?:encrypt|decrypt)\\(",
              "mcrypt_"
            ]
          }
        }
      ],
      "messages": {
        "pass": "Magento's built-in APIs are used for encryption and session management.",
        "fail": "Custom crypto/session code found. Use Magento Framework Encryption and Session APIs instead."
      }
    }
  ]
}