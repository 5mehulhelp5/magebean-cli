{
  "control": "MB-C06",
  "title": "Cache & Indexing Health",
  "rules": [
    {
      "id": "MB-R037",
      "title": "Full Page Cache (FPC) enabled",
      "control": "MB-C06",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "php_array_eq",
          "args": {
            "file": "app/etc/env.php",
            "path": "system.default.system/full_page_cache/caching_application",
            "equals": 2
          }
        }
      ],
      "messages": {
        "pass": "Full Page Cache (FPC) is enabled and configured.",
        "fail": "Full Page Cache is disabled or not using Varnish. Enable FPC for performance."
      }
    },
    {
      "id": "MB-R038",
      "title": "Cache backend is Redis/Varnish (not file)",
      "control": "MB-C06",
      "severity": "medium",
      "op": "any",
      "checks": [
        {
          "name": "php_array_eq",
          "args": {
            "file": "app/etc/env.php",
            "path": "cache.frontend.default.backend",
            "equals": "Cm_Cache_Backend_Redis"
          }
        },
        {
          "name": "php_array_eq",
          "args": {
            "file": "app/etc/env.php",
            "path": "cache.backend",
            "equals": "redis"
          }
        }
      ],
      "messages": {
        "pass": "Cache backend is configured to use Redis or Varnish.",
        "fail": "Cache backend is still using file-based storage. Switch to Redis or Varnish."
      }
    },
    {
      "id": "MB-R039",
      "title": "Indexers are READY (no backlog)",
      "control": "MB-C06",
      "severity": "medium",
      "op": "all",
      "checks": [
        {
          "name": "text_grep",
          "args": {
            "file": "var/.indexer_status",
            "must_match": ["READY"]
          }
        }
      ],
      "messages": {
        "pass": "All indexers are in READY state with no backlog.",
        "fail": "Some indexers are not READY. Run `bin/magento indexer:reindex`."
      }
    },
    {
      "id": "MB-R040",
      "title": "Session storage hardened (Redis with auth)",
      "control": "MB-C06",
      "severity": "high",
      "op": "all",
      "checks": [
        {
          "name": "php_array_eq",
          "args": {
            "file": "app/etc/env.php",
            "path": "session.save",
            "equals": "redis"
          }
        },
        {
          "name": "php_array_exists",
          "args": {
            "file": "app/etc/env.php",
            "path": "session.redis.password"
          }
        }
      ],
      "messages": {
        "pass": "Sessions are stored in Redis with authentication configured.",
        "fail": "Session storage is not hardened. Use Redis with a password for secure sessions."
      }
    },
    {
      "id": "MB-R041",
      "title": "No dev cache backends (avoid file backend)",
      "control": "MB-C06",
      "severity": "low",
      "op": "any",
      "checks": [
        {
          "name": "php_array_neq",
          "args": {
            "file": "app/etc/env.php",
            "path": "cache.frontend.default.backend",
            "not_equals": "Cm_Cache_Backend_File"
          }
        },
        {
          "name": "php_array_neq",
          "args": {
            "file": "app/etc/env.php",
            "path": "cache.backend",
            "not_equals": "file"
          }
        }
      ],
      "messages": {
        "pass": "No file-based cache backend detected.",
        "fail": "File cache backend detected. Replace with Redis or Varnish for production."
      }
    }
  ]
}
